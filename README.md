리그오브레전드 P.S Bot <img src="https://i.ibb.co/4f1nw7T/P-S.webp" width="35px" height="35px" title="px(픽셀) 크기 설정" alt="P.S"></img>
=
프로젝트 참여자
-
|학과|학번|이름|
|---|---|---|
|컴퓨터공학과|20101246|신민규|
   

프로젝트 동기 & 설명
-
전 세계 게임들 중 가장 많은 유저 수를 지닌 게임들 중 하나이며 저도 오랫동안 즐기고 있는 **리그 오브 레전드(League of Legend)** 게임이 이렇게나 오래 인기를 끌 수 있었던 이유는 타 AOS 게임보다 진입 장벽은 낮췄다는 점에 있습니다. 그렇다고 해도, 10년이 넘는 시간 동안 축적된 데이터와 매번 업데이트 되는 패치내용으로 인해 알아야 할 것이 적다고 할 수 없고, 랭크를 높이기 위해선 더더욱이 그러한 사항을 인지하고 있어야 합니다. 그렇기 때문에, 챔피언 빌드를 알려주는 사이트인 [OP.GG](https://www.op.gg/champions) 나 게임의 메타와 공략을 알려주는 유튜브 [프로 관전러 P.S](https://www.youtube.com/@ProfessionalSpectator) 같은 것들이 자연스럽게 롤의 인기도에 비례하는 인기를 누리게 된 것입니다. 따라서, 저는 이 **프로 관전러 P.S**를 모티브로 한 디스코드 봇을 만들게 되었습니다.   
> 개발자 레퍼런스에서 "애플리케이션을 사고 팔고 누구나 만들 수 있는 개발 환경과 오픈 소스를 제공해줬던 것처럼 Chatgpt 같은 Open AI를 누구나 만들어보고 자신에게 맞는 '맞춤형 챗GPT'를 만들어볼 수 있는 시대가 올 것이다." 라고 했다는 이야기를 듣고, Open Source Software 텀프로젝트로 '맞춤형 챗GPT' 같은 나에게 필요한 인공지능 봇을 만들어보고 싶다는 생각도 있었습니다.

<br> 

### ● 왜 디스코드 봇인가? 
</br>

* 디스코드 플랫폼에서 인공지능 봇을 쉽게 만들어볼 수 있도록 기능을 제공해주기 때문에, 저 같이 인공지능 봇을 만들어본 경험이 없는 사람은 디스코드 봇을 만들어 보는 것도 괜찮겠다는 생각이 들었습니다.

<br>

* **롤**과 **디스코드**는 뗄레야 뗄 수 없는 관계인데, 이 점을 이용해서 재작년 Open Source Software 수업에서 어떤 팀이 롤 관련 서비스를 해주는 [꿀벌봇](https://github.com/NyaNyak/discord-beebot/tree/main)이라는 봇을 만든 것을 보고 아이디어가 되게 괜찮다고 생각했습니다. 하지만, 2년 전에 만들어진 만큼 **최신 업데이트 내용을 반영하지 못하고 있고**, 최근 바뀐 닉네임 형식이 로직에 반영되지 않았다는 점과 마찬가지로 그러한 변경사항을 아직 반영하지 못한 웹 사이트인 [your.gg](https://your.gg/ko/kr/home)에서 데이터를 얻어온다는 점에서 문제가 있었습니다. 앞서 말한 문제를 Riot API를 이용해 고치고 롤을 10년 넘게 하면서 얻은 경험들을 기반으로 **새로운 기능**을 추가해보고 싶다는 생각이 들었습니다.

</br>

프로젝트 후기 & 팁(?)
-

사실 디스코드 봇은 어렸을 때부터 사용해봐서 친숙하기도 하고 Open Source가 많아 개발 난이도가 높지 않을 것이라 생각했는데, 
생각보다 너무 어려웠던 것 같습니다. 난생 처음보는 라이엇 공식 API인 **Riot API 명세서를 읽고 적절한 http를 요청(request)해 
정보를 받아오고, 받아온 정보를 가공**하는 과정이 이 프로젝트의 관건이었습니다. 이번 년도에 백엔드에 관심이 생긴 만큼 API 명세서를 읽고
API를 요청하는 경험도 필요했는데, 이번 프로젝트를 통해 그런 경험을 많이 한 것 같아 뿌듯하는 생각도 듭니다. 
API 명세서를 읽고 개발해보는 것이 이번이 처음이라 잘못된 요청 정보를 전송하는 경우도 많았고, 
오류가 발생했을 때 로그(log)를 띄워보면서 문제점을 찾는 과정에서 어려웠던 부분들도 많았습니다. 
그래서 디스코드 봇을 만들고자 하시는 분들이 보면 도움이 될 만한 부분들을 따로 꼽아서 어떻게 해결했는지 정리해봤습니다.

### ▼ 시작부터 문제
> 채팅 봇을 처음 만들어보다 보니 내가 보낸 명령어에 반응하게 하도록 해야 한다는 벽에 시작부터 막혀 막막했던 기억이 있습니다.</br>
> ➜ 아마도 오픈 소스가 없었다면 개발해내지 못했을 것 같습니다.. </br>

### ▼ 20초가 넘게 걸리는 응답 속도 문제 </br>
> 처음에 코드를 설계할 땐 오픈 소스를 참고하면서 request 방식(동기)으로 설계했더니 응답 속도도 느리고,
> Discord 봇의 이벤트 루프가 블로킹(동기) HTTP 요청에 의해 차단되는 오류도 발생했습니다. 게임 중에 신속하게 정보를 얻기 위한 목적으로 만들어진 
> **P.S 봇** 취지가 있기 때문에, 이 응답 속도 문제와 오류를 해결하는 과정이 쉽지 않았던 것 같습니다. <br>
> ➜ asyncio, aiohttp 패키지를 활용한 비동기 방식으로 설계하여 상세 정보 요청에 대해 병렬적으로 처리할 수 있게 하여 문제를 해결헀습니다.

### ▼ 요청 속도가 빨라지니 발생하는 ERROR 429 (Riot API rate limits) & 효율적인 API 요청 <br>
> 개발용 Riot api key로 정보를 받아올 때 **요청 횟수에 제한**이 걸려 있습니다.(1초에 20번 2분에 100번)
> 이전까진 동기 방식으로 처리해 요청 속도가 애초에 느리다 보니 몰랐는데, 각 플레이어의 최근 20게임에 대한 승률을 
> 에이스 플레이어의 기준으로 해서 승률에 대한 정보는 Riot api에서 제공해주지 않아 10명이나 되는 플레이어의 
> 최근 20게임에 대한 세부 정보를 모두 요청하게 되면서 **429 에러**가 발생한 것이었습니다. <br>
> ➜ 그래도 **에이스 플레이어의 기준**은 그대로 하고 싶어 429 에러 발생 시 일정 시간을 대기하고 다시 요청하는 방식으로 수정하려 했으나,
> 요청 시간이 너무 오래 걸려서 어쩔 수 없이 20개의 게임 세부 정보를 요청할 필요 없이 유저의 총 승리/패배수 정보를 가져와 계산한 승률을
> 에이스 플레이어의 기준으로 잡게 됐습니다. <br>
> ➜ 코드를 어떤 구조로 설계하느냐에 따라 **API를 효율적으로 요청**할 수 있다는 부분을 기억해두면 좋을 것 같습니다.
> 
### ▼ 비동기 방식으로 인한 오버헤드 문제 </br>
> 만능인줄만 알았던 비동기 방식도 API에 Json 형식의 파일을 요청할 때마다 매번 세션(session)을 생성해줘야 한다는 점 때문에
> **오버헤드**가 발생하는 단점이 있다는 사실을 알게 됐습니다. 
> ➜ 각 HTTP 요청마다 새로운 aiohttp.ClientSession을 생성하는 대신, **세션을 재사용**하여 오버헤드를 줄였습니다.

<br>

P.S 봇 사용법 (사용자)
-
### ● P.S 봇 초대 방법
1. 직접 [P.S 봇 초대 링크](https://discord.com/api/oauth2/authorize?client_id=1179801477712195696&permissions=8&scope=bot)를 통해 P.S 봇을 사용하고 싶은 서버로 초대합니다.</br> (단, 해당 서버에 대한 '관리자 권한'이 있어야만 초대 가능합니다.)

</br>

### ● P.S 봇 기능 및 명령어

<br>

* P.S 봇이 채널에 입장했을 때
![img.png](img.png)
</br>

<br>

* 사람이 채널에 입장했을 때

</br>

<br>

* !전적검색 닉네임#태그 (ex. !전적검색 민규#TAG)
> 해당 유저의 정보를 확인해볼 수 있습니다.
![img_1.png](img_1.png)

</br>

<br>

* !인게임분석 닉네임#태그 (ex. !인게임분석 민규#TAG)
> 해당 게임에서 누구와 게임을 풀어나가야 할지, 적팀에서 누구를 조심해야 할지를 승률에 기반해서 알려줍니다.

</br>

P.S 봇 사용법 (개발자)
-
1) 디스코드 사용자 설정(톱니바퀴) > 고급 > 개발자 모드 ON

2) 파이썬 초기 개발 환경을 세팅합니다. <br> (콘솔 창에 *pip intall discord*를 입력해 dicord 패키지를 설치해줘야 하는데, *pip*가 설치가 돼 있어야 합니다.) </br>

3) 로컬 리포지터리로 **git clone** 합니다.

4) [디스코드 개발자 포털](https://discord.com/developers/applications)로 접속한 후, 우측 상단 [New Application]을 클릭합니다.

5) 좌측 Bot 탭 > [Add Bot]을 클릭 > 아래처럼 Intents 관련 설정을 모두 ON으로 바꿔줍니다. (무조건)

![image](https://github.com/uykm/P.Sbot-Discord/assets/98581610/3d846094-2cd4-46ae-ac1b-9a967d91668b)

6) 좌측 OAuth2 탭 > URL Generater > SCOPES - bot 체크 > BOT PERMiSSIONS - Administrator 체크 > 맨 아래 생성된 URL로 접속하여 원하는 서버에 봇을 초대해줍니다.

![image](https://github.com/uykm/P.Sbot-Discord/assets/98581610/e81c1198-09a7-419c-afb3-b411bad9f915)

7) 좌측 Bot 탭 > Token을 copy(reset을 해줘야 하는 경우엔 reset) > 로컬 리포지터리 내에 텍스트 파일(Discord_token)을 생성해 '붙여넣기' 합니다.

8) [DEVELOPMENT API KEY 발급](https://developer.riotgames.com/) 혹은 만료 기간을 길게 하고 싶다면 [PERSONAL API KEY 발급](https://developer.riotgames.com/app-type)받은 후에, 디스코드 토큰을 텍스트 파일에 복사 붙여넣기 해준 것처럼 텍스트 파일(Riot_api_token)에 '붙여넣기' 해줍니다.

9) 다시 개발 환경으로 돌아와 'main.py'를 실행! (끝)

<br>

사용한 API
-
### Riot API
* https://developer.riotgames.com/apis (API 명세서)

</br>

참고 자료
-

<br>

* [Tistory - 김윤웅](https://yunwoong.tistory.com/212)
> 디스코드 봇 초기 세팅을 할 때 참고했습니다.

</br>

* [Tistory - Nerdy](https://whiplash-bd.tistory.com/42)
> Riot API 명세서에 대한 설명을 참고했습니다.

<br>

* [GitHub - NyaNyak](https://github.com/NyaNyak/discord-beebot)
> 1. 코드 구조를 참고했습니다.  
> 2. 챔피언 이름(한글/영어) 딕셔너리 파일(chamDB.py)을 그대로 가져와서 몇 가지 챔피언을 추가했습니다.  
> 3. 전적 검색 결과를 표현하는 UI 디자인 코드(search.py)를 사용했습니다.

</br>

License
-
이 오픈소스는 [MIT License](https://github.com/uykm/P.Sbot-Discord/blob/main/LICENSE)를 기반으로 하고 있습니다.
